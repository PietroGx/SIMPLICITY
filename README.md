# SIMPLICITY 2.0+

**Stochastic sIMulation of Viral sPreading and evoLutIon aCcountIng for wiThin-host dYnamics**

SIMPLICITY is a multi-layer, agent-based stochastic framework designed to bridge the gap between intra-host viral replication and population-level transmission. Version 2.2.4 introduces mixed populations (standard and long shedder individuals), allowing for modeling of chronic infections and their impact on viral evolution.

[![Documentation Status](https://readthedocs.org/projects/simplicity/badge/?version=latest)](https://simplicity.readthedocs.io/en/latest/)
[![License](https://img.shields.io/github/license/PietroGx/SIMPLICITY)](LICENSE)
[![Python Version](https://img.shields.io/badge/python-3.12+-blue.svg)](https://www.python.org/)

---

## üöÄ New in Version 2.2.4: Heterogeneous Evolution

The 2.2.x release transitions the model from acute-only dynamics to a generalized framework for population heterogeneity.

* **Host-Specific Dynamics ($g \in \{stan, long\}$):** Model "Standard" and "Long-Shedder" host populations with distinct infectiousness windows and mutation rates.
* **Automated Calibration:** A pipeline to target empirical Observed Substitution Rates ($OSR$) across mixed populations by solving for the required $NSR_{base}$.

---

## üìñ Documentation

[https://simplicity.readthedocs.io](https://simplicity.readthedocs.io)

---

## Getting Started

### Installation

> üêç Requires **Python 3.12 or later**

Clone the repository and install dependencies:

```bash
git clone https://github.com/PietroGx/SIMPLICITY.git
cd SIMPLICITY
pip install -r docs/requirements.txt
```
or use the `simplicity.yml` file to create the conda environment.

---

## SIMPLICITY Usage and Output

### Usage

Before running a simulation, it's important to understand the following terminology:

| Term               | Definition                                                                         |
|--------------------|------------------------------------------------------------------------------------|
| **Experiment** | A group of simulations with varying parameters to investigate a specific question. |
| **Simulation** | A set of seeded simulations with shared parameters and different random seeds.     |
| **Seeded simulation** | A single simulation with a unique set of parameters and a random seed.           |

To execute an experiment, use the `runme.py` script with the following parameters:

- `experiment_name`: **str**, name of the experiment
- `experiment_settings`: **function**, specifies or loads experiment settings
- `simplicity_runner`: **module**, runner for the experiment
  
You can run an example via:
```bash
python scripts/experiments/00_example_experiment_runme.py
```

### The Calibration Pipeline
To initialize a simulation that matches specific empirical data (e.g., $OSR_{target} = 0.0008$ and multiplier $M=2$), use the calibration utility:

```bash
python scripts/tuning/calibrate_pipeline.py --target-osr 0.0008 --M 2 --verify
```

---

## Core Model Components

### Intra-host Dynamics 
We employ a 21-state Markov model to track individual infectiousness and detectability. The residency time in each compartment is controlled via $\tau$ parameters.
* **Standard Hosts:** Optimized for acute infection profiles.
* **Long Shedders:** Configurable via `tau_3_long` to model chronic infections.

### Multi-Lineage Evolution ($k_v$)
Unlike simple SIR models, SIMPLICITY simulates **viral compartmentalization**. The $k_v$ parameter controls the rate at which new intra-host dominant lineages emerge. Version 2.2.4 accounts for the "Evolutionary Weight" ($W_g$) generated by these increasing lineages over the course of a long infection.

### Phenotypic Selection
Two models are available:
1. **Baseline**: Fitness based on average Hamming distance from wild-type.
2. **Immune waning**: Accounts for immune memory decay and population exposure (antibody pharmacokinetic).

---

## Model Output

Each seeded simulation generates:

| File Name                        | Description |
|----------------------------------|-------------|
| `final_time.csv`                 | Simulation end time |
| `fitness_trajectory.csv`         | Avg. fitness over time |
| `individuals_data.csv`           | Metadata for each individual |
| `lineage_frequency.csv`          | Frequency of viral lineages |
| `phylogenetic_data.csv`          | Information about lineages |
| `sequencing_data_regression.csv` | Data for estimating OSR |
| `sequencing_data.fasta`          | Simulated sequences |
| `simulation_trajectory.csv`      | SIRD compartment data |

---

## Project Structure

```plaintext
SIMPLICITY/
‚îú‚îÄ‚îÄ scripts/                # Experiments and calibration tools
‚îÇ   ‚îî‚îÄ‚îÄ archive/            # Legacy code from the original publication
‚îú‚îÄ‚îÄ simplicity/             # Core framework modules
‚îÇ   ‚îú‚îÄ‚îÄ evolution/          # Mutational logic (Poisson-based)
‚îÇ   ‚îú‚îÄ‚îÄ phenotype/          # Fitness & Immune escape models
‚îÇ   ‚îú‚îÄ‚îÄ runners/            # Local, Multiprocessing, and SLURM support
‚îÇ   ‚îî‚îÄ‚îÄ tuning/             # OSR/NSR calibration & Diagnosis rate logic
‚îî‚îÄ‚îÄ tests/                  # PyTest suite for core dynamics
```

---

## Contributing

Contributions are welcome! If you‚Äôd like to report a bug or propose a feature contact me!

---

## üìÑ License

This project is licensed under the GPL3 licence. See the [LICENSE](LICENSE) file for details.

---

## üë• Authors

- Pietro Gerletti
- Jean-Baptiste Escudi√©
